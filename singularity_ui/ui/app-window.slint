import {
    Button,
    LineEdit,
    ScrollView,
    ListView,
    VerticalBox,
    HorizontalBox,
} from "std-widgets.slint";
import { BasicInfo } from "other/confirm-download.slint";

export struct ChatMessage {
    text: string,
    is_user: bool,
}

// Delegate component for rendering each message
component ChatRow {
    in property <string> text;
    in property <bool> is_user;

    HorizontalBox {
        spacing: 8px;
        alignment: start;
    
        // Spacer pushes bubble left or right
        if is_user: Rectangle {
            width: 10%;
        }

        Rectangle {
            border-radius: 8px;
            background: is_user ? #2a6ef0 : #444;
            Text {
                text: root.text;
                overflow: elide;
                horizontal-alignment: center;
                color: is_user ? #fff : #eee;
                wrap: word-wrap;
                max-width: 300px;
                min-height: 20px;
                min-width: 200px;
            }
        }

        if !is_user: Rectangle {
            width: 10%;
        }
    }
}

export component App inherits Window {
    width: 500px;
    height: 700px;

    default-font-family: "monospace";
    default-font-size: 16px;

    title: "LLM Chat Client";

    in-out property <bool> show_download_warning;
    in-out property <bool> finished_loading: true;
    in-out property <bool> download_finished;
    in-out property <[ChatMessage]> messages;

    out property <string> input_text: "";
    callback send_clicked(string);
    callback download_accepted();

    dialog := BasicInfo {
        visible: !show_download_warning;
        text: "Application needs to download additional files.";
        on_accept => {
            root.download_accepted();
            show_download_warning = true;
        }
    }

    if !finished_loading && show_download_warning : Text {
        text: "Loading required resources";
    }

    if show_download_warning && finished_loading: VerticalBox {
        spacing: 8px;
        padding: 8px;

        ScrollView {
            height: 85%;
            width: 90%;

            ListView {
                // Use ChatRow as delegate
                for msg in root.messages: ChatRow {
                    text: msg.text;
                    is_user: msg.is_user;
                }
            }
        }

        HorizontalBox {
            spacing: 8px;
            height: 10%;

            LineEdit {
                text <=> root.input_text;
                placeholder-text: "Type your messageâ€¦";
                width: 70%;

                accepted => {
                    if (!root.input_text.is-empty) {
                        root.send_clicked(root.input_text);
                        root.input_text = "";
                    }
                }
            }

            Button {
                text: "Send";
                min-width: 50px;

                clicked => {
                    if (!root.input_text.is-empty) {
                        root.send_clicked(root.input_text);
                        root.input_text = "";
                    }
                }
            }
        }
    }
}
